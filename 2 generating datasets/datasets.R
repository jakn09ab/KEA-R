# Create cpr dataset ----
#========================================================
library(data.table)
library(dplyr)
library(lubridate)
set.seed(123)
CPR_ENCRYPTED <- replicate(1000, {  #replicates three sample functions 1000 times and pastes them together with nothing ("") in between.
                    paste(sample(LETTERS[1:26],1, replace = TRUE), 
                      sample(LETTERS[1:26],1, replace = TRUE), 
                      sample(1:100,1, replace = TRUE), sep = "")
                    })

birth_year <- sample(1930:2018, 1000, replace = TRUE) #samples from interval 1930-2018

cpr <- data.frame(CPR_ENCRYPTED, birth_year) #creates dataframe from vectors

setDT(cpr) #sets data.table
cpr[, birth_month:= sample(1:12, 1000, replace = TRUE)]
longmonths <- c(1,3,5,7,8,10,12)
cpr[birth_month %in% longmonths, day_of_birth:= sample(1:31, .N, replace = TRUE)] #months with 31 days, filters cprs in which values in birth_month column appers in longmonths
cpr[birth_month == 2, day_of_birth:= sample(1:28, .N, replace = TRUE)]#february #after first comma day_of_birth is generated by reference a faster and more succinct method than base R.

cpr[birth_month %in% c(4,6,9,11), day_of_birth:= sample(1:30, .N, replace = TRUE)] #30day months
cpr[, sex:= sample(c(0,1), 1000, replace = TRUE)]
cpr[,date_of_birth:= ymd(paste(birth_year, birth_month, day_of_birth, sep = "-"))]
B <- cpr[sample(150)][,date_of_death:= date_of_birth + 65*365+365*round(rnorm(150, 10, 5), digits = 0)][,.(CPR_ENCRYPTED, date_of_death)]#NOTICE how I chain the syntax. Try running the seperate hard brackets.
setkey(B, CPR_ENCRYPTED)
setkey(cpr, CPR_ENCRYPTED)
cpr <- merge(cpr, B, all = TRUE)
cpr[, status:= ifelse(!is.na(date_of_death), "90", "01")]
setnames(cpr, "date_of_death", "statusdato")
B <- max(cpr$statusdato, na.rm = TRUE)
cpr[status == "01", statusdato:= B]

#create lsr dataset----

for (i in cpr$CPR_ENCRYPTED) {
  if(i == cpr$CPR_ENCRYPTED[1]) {AA <- 0}
  A <- sample(0:10,1)
  ATClist <-  replicate(A, { 
    paste(sample(LETTERS[1:26], 1), "0", sample(1:9, 1), sample(LETTERS[1:26], 1), sep = "", "0", sample(1:9, 1))
  })
  CPR_ENCRYPTED <- rep(i, A) 
  C <- data.frame(ATClist,CPR_ENCRYPTED)
  AA <- AA+1
  ifelse(AA == 1, lsr <- C, lsr <- rbind(lsr,C))
}

setDT(lsr)
setDT(cpr)
setkey(lsr, CPR_ENCRYPTED)
setkey(cpr, CPR_ENCRYPTED)
lsr <- merge(lsr, cpr, all.x = TRUE)
lsr[, EKSD:= date_of_birth+365*rnorm(1, mean=60, sd = 15)] #starts medicin around 60 years, sd 15 years.
lsr[, DDD:= replicate(.N, {sample(c(30,30,30,60,60,60,90,90,120), 1, replace = TRUE)})]
lsr <- lsr[,.(CPR_ENCRYPTED, ATClist, EKSD, DDD)] #selects data by column names

#scrambles data lsr and cpr
lsr$EKSD <- as.character(lsr$EKSD)
cpr[,date_of_birth:=NULL]
cpr[,birth_year:= as.character(birth_year)] 
cpr[,birth_month:= as.character(birth_month)]
cpr[,day_of_birth:= as.character(day_of_birth)]
cpr[,statusdato:= as.character(statusdato)]
#remove superfluous datastumps
rm(A, ATClist, B, birth_year, CPR_ENCRYPTED, i, longmonths, AA, C)

fwrite(cpr, file = "/Users/JakobKnudsen/github/KEA-R/2 generating datasets/cpr.csv")
fwrite(lsr, file = "/Users/JakobKnudsen/github/KEA-R/2 generating datasets/lsr.csv")
